<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Station - Raspberry Pi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .download {
            color: green;
            font-weight: bold;
            text-transform: uppercase;
            text-decoration: none;
        }
        .delete {
            color: red;
            font-weight: bold;
            text-transform: uppercase;
            text-decoration: none;
        }
        .restart {
            background-color: #ff9800;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .restart:hover {
            background-color: #e68900;
        }
        .reset-db {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .reset-db:hover {
            background-color: #c82333;
        }
        .cleanup {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .cleanup:hover {
            background-color: #218838;
        }
        .clear-logs {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .clear-logs:hover {
            background-color: #c82333;
        }
        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }
        input[type="checkbox"] {
            transform: scale(1.5);
        }
        .serial-monitor {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .weather-card {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 10px;
            border-radius: 10px;
            min-width: 200px;
            text-align: center;
        }
        .weather-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .weather-label {
            font-size: 14px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå§Ô∏è Weather Station - Raspberry Pi Version</h1>
        
        <!-- Current Weather Display -->
        <h2>Current Weather Data</h2>
        <div id="current-weather">
            {% if recent_data %}
                {% set latest = recent_data[0] %}
                <div class="weather-card">
                    <div class="weather-label">Temperature (Outdoor)</div>
                    <div class="weather-value">{{ "%.1f"|format(latest[1]|float) if latest[1] is not none else "N/A" }}¬∞C</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Humidity (Outdoor)</div>
                    <div class="weather-value">{{ latest[2] if latest[2] is not none else "N/A" }}%</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Wind Speed</div>
                    <div class="weather-value">{{ "%.1f"|format(latest[3]|float) if latest[3] is not none else "N/A" }} km/h</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Wind Direction</div>
                    <div class="weather-value">{{ latest[4] if latest[4] is not none else "N/A" }}¬∞</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Pressure</div>
                    <div class="weather-value">{{ "%.1f"|format(latest[5]|float) if latest[5] is not none else "N/A" }} inHg</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Device ID</div>
                    <div class="weather-value">{{ latest[7] if latest[7] is not none else "N/A" }}</div>
                </div>
            {% else %}
                <p>No weather data available yet.</p>
            {% endif %}
        </div>

        <!-- Current Network Information -->
        <h2>Current Network Information</h2>
        <div style="background-color: #e8f4fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <p><strong>Current IP Address:</strong> <span id="current-ip">Loading...</span></p>
            <p><strong>WiFi SSID:</strong> <span id="current-ssid">Loading...</span></p>
            <p><strong>Post URL:</strong> <span id="current-post-url">Loading...</span></p>
            <p><strong>API Endpoint:</strong> <span id="current-api-url">Loading...</span></p>
        </div>

        <!-- Settings Form -->
        <h2>Weather Station Settings</h2>
        <form action="/save" method="POST">
            <table>
                <tr>
                    <td><strong>Device ID:</strong></td>
                    <td><input type="number" name="id" value="{{ settings.id }}" min="1" max="999" style="font-weight: bold; background-color: #fff3cd;"></td>
                </tr>
                <tr>
                    <td>WiFi SSID:</td>
                    <td><input type="text" name="ssid" value="{{ settings.ssid }}" placeholder="Enter WiFi network name"></td>
                </tr>
                <tr>
                    <td>WiFi Password:</td>
                    <td><input type="password" name="password" value="{{ settings.password }}" placeholder="Enter WiFi password"></td>
                </tr>
                <tr>
                    <td>Use Static IP:</td>
                    <td><input type="checkbox" name="useStaticIP" {% if settings.useStaticIP %}checked{% endif %} onchange="toggleStaticIP()"></td>
                </tr>
                <tr id="static-ip-row" style="{% if not settings.useStaticIP %}display: none;{% endif %}">
                    <td>Static IP:</td>
                    <td><input type="text" name="staticIP" value="{{ settings.staticIP }}" placeholder="e.g., 192.168.1.100"></td>
                </tr>
                <tr id="gateway-row" style="{% if not settings.useStaticIP %}display: none;{% endif %}">
                    <td>Gateway:</td>
                    <td><input type="text" name="gateway" value="{{ settings.gateway }}" placeholder="e.g., 192.168.1.1"></td>
                </tr>
                <tr id="subnet-row" style="{% if not settings.useStaticIP %}display: none;{% endif %}">
                    <td>Subnet:</td>
                    <td><input type="text" name="subnet" value="{{ settings.subnet }}" placeholder="e.g., 255.255.255.0"></td>
                </tr>
                <tr>
                    <td>DNS Server:</td>
                    <td><input type="text" name="dnsServer" value="{{ settings.dnsServer }}" placeholder="e.g., 8.8.8.8"></td>
                </tr>
                <tr>
                    <td>Post URL:</td>
                    <td><input type="text" name="postUrl" value="{{ settings.postUrl }}" readonly style="background-color: #f8f9fa; color: #6c757d;"></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="submit" value="üíæ Save Settings" style="background-color: #28a745; font-weight: bold;">
                        <button type="button" onclick="autoDetectSettings()" style="background-color: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                            üîÑ Auto-Detect Network
                        </button>
                    </td>
                </tr>
            </table>
        </form>

        <!-- System Control -->
        <h2>System Control</h2>
        <a href="/restart" class="restart" onclick="return confirm('Are you sure you want to restart the system?')">
            üîÑ RESTART SYSTEM
        </a>
        <button class="reset-db" onclick="resetDatabase()">
            üóëÔ∏è RESET DATABASE
        </button>
        <button class="cleanup" onclick="manualCleanup()">
            üßπ CLEANUP OLD DATA
        </button>
        <button class="clear-logs" onclick="clearLogs()">
            üóëÔ∏è CLEAR LOGS
        </button>
        <button class="cleanup" style="background-color: #007bff;" onclick="manualSync()">
            üåê SYNC TO SERVER
        </button>

        <!-- File Management -->
        <h2>Data Files</h2>
        <table>
            <tr>
                <th>File Name</th>
                <th>Actions</th>
            </tr>
            {% for file in files %}
            <tr>
                <td>{{ file }}</td>
                <td>
                    <a href="/download?file={{ file }}" class="download">üì• DOWNLOAD</a> | 
                    <a href="/delete?file={{ file }}" class="delete" onclick="return confirm('Are you sure you want to delete this file?')">üóëÔ∏è DELETE</a>
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- Connected Devices -->
        <h2>Connected Devices</h2>
        <p><span class="status-indicator status-online"></span>{{ connected_devices }}</p>

        <!-- Recent Data Table -->
        <h2>Recent Weather Data</h2>
        <table>
            <tr>
                <th>Date/Time</th>
                <th>Temp Out (¬∞C)</th>
                <th>Humidity Out (%)</th>
                <th>Wind Speed (km/h)</th>
                <th>Wind Dir</th>
                <th>Pressure (inHg)</th>
                <th>Model</th>
                <th>Device ID</th>
                <th>Status</th>
            </tr>
            {% for data in recent_data %}
            <tr>
                <td>{{ data[0] if data[0] is not none else "N/A" }}</td>
                <td>{{ "%.1f"|format(data[1]|float) if data[1] is not none else "N/A" }}</td>
                <td>{{ data[2] if data[2] is not none else "N/A" }}</td>
                <td>{{ "%.1f"|format(data[3]|float) if data[3] is not none else "N/A" }}</td>
                <td>{{ data[4] if data[4] is not none else "N/A" }}¬∞</td>
                <td>{{ "%.1f"|format(data[5]|float) if data[5] is not none else "N/A" }}</td>
                <td>{{ data[6] if data[6] is not none else "N/A" }}</td>
                <td>{{ data[7] if data[7] is not none else "N/A" }}</td>
                <td>
                    {% if data[8] == 1 %}
                        ‚úÖ Uploaded
                    {% else %}
                        ‚è≥ Pending
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- Serial Monitor -->
        <h2>System Log</h2>
        <div id="serial" class="serial-monitor">Loading...</div>
    </div>

    <script>
        // Auto-refresh serial monitor
        function updateSerial() {
            fetch('/serial')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('serial').textContent = data;
                })
                .catch(error => {
                    console.error('Error fetching serial data:', error);
                });
        }

        // Update network information
        function updateNetworkInfo() {
            fetch('/api/network/info')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const networkInfo = data.network_info;
                        document.getElementById('current-ip').textContent = networkInfo.local_ip;
                        document.getElementById('current-ssid').textContent = networkInfo.wifi_ssid || 'Not connected';
                        document.getElementById('current-post-url').textContent = networkInfo.misol_endpoint;
                        document.getElementById('current-api-url').textContent = networkInfo.api_endpoint;
                    }
                })
                .catch(error => {
                    console.error('Error fetching network info:', error);
                });
        }

        // Toggle static IP fields visibility
        function toggleStaticIP() {
            const useStaticIP = document.querySelector('input[name="useStaticIP"]').checked;
            const staticIPRow = document.getElementById('static-ip-row');
            const gatewayRow = document.getElementById('gateway-row');
            const subnetRow = document.getElementById('subnet-row');
            
            if (useStaticIP) {
                staticIPRow.style.display = '';
                gatewayRow.style.display = '';
                subnetRow.style.display = '';
            } else {
                staticIPRow.style.display = 'none';
                gatewayRow.style.display = 'none';
                subnetRow.style.display = 'none';
            }
        }

        // Auto-detect network settings
        function autoDetectSettings() {
            fetch('/api/network/info')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const networkInfo = data.network_info;
                        
                        // Update form fields with detected values
                        document.querySelector('input[name="ssid"]').value = networkInfo.wifi_ssid || '';
                        document.querySelector('input[name="staticIP"]').value = networkInfo.local_ip;
                        
                        // Auto-detect gateway (first 3 octets + 1)
                        const ipParts = networkInfo.local_ip.split('.');
                        if (ipParts.length === 4) {
                            document.querySelector('input[name="gateway"]').value = `${ipParts[0]}.${ipParts[1]}.${ipParts[2]}.1`;
                        }
                        
                        // Update Post URL
                        document.querySelector('input[name="postUrl"]').value = networkInfo.api_endpoint;
                        
                        alert('‚úÖ Network settings auto-detected and updated!');
                    }
                })
                .catch(error => {
                    console.error('Error auto-detecting settings:', error);
                    alert('‚ùå Error auto-detecting network settings');
                });
        }

        // Update serial monitor every second
        setInterval(updateSerial, 1000);
        updateSerial(); // Initial load

        // Update network info every 5 seconds
        setInterval(updateNetworkInfo, 5000);
        updateNetworkInfo(); // Initial load

        // Auto-refresh weather data every 30 seconds
        function updateWeather() {
            location.reload();
        }
        setInterval(updateWeather, 30000);

        // Reset database function
        function resetDatabase() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL weather data from the database!\n\nThis action cannot be undone. Are you sure you want to continue?')) {
                if (confirm('Are you REALLY sure? This will permanently delete all weather records!')) {
                    fetch('/api/database/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('‚úÖ ' + data.message);
                            location.reload(); // Refresh page to show updated data
                        } else {
                            alert('‚ùå Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('‚ùå Error resetting database: ' + error.message);
                    });
                }
            }
        }

        // Manual cleanup function - only database > 2 months
        function manualCleanup() {
            if (confirm('üßπ This will delete weather data older than 2 months from database.\n\nThis helps free up disk space. Continue?')) {
                fetch('/api/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('‚úÖ ' + data.message);
                        location.reload(); // Refresh page to show updated data
                    } else {
                        alert('‚ùå Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Error during cleanup: ' + error.message);
                });
            }
        }

        // Clear logs function - delete old log files (not from today)
        function clearLogs() {
            if (confirm('üóëÔ∏è This will delete old log files (not from today).\n\nToday\'s log will be kept. Continue?')) {
                fetch('/api/logs/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('‚úÖ ' + data.message);
                        location.reload(); // Refresh page to show updated data
                    } else {
                        alert('‚ùå Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Error clearing logs: ' + error.message);
                });
            }
        }

        // Manual sync to external server
        function manualSync() {
            fetch('/api/sync/manual', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                alert((data.status === 'success' ? '‚úÖ ' : '‚ÑπÔ∏è ') + data.message);
                location.reload();
            })
            .catch(error => {
                console.error('Manual sync error:', error);
                alert('‚ùå Error syncing data: ' + error.message);
            });
        }
    </script>
</body>
</html>
